"use strict";Clazz.createPackage("com.wag.emailSubscriptionModal.js");Clazz.com.wag.emailSubscriptionModal.js.EmailSubscriptionModal=Clazz.extend(Clazz.Widget,{initialize:function(){this.myContainer="wagEmailSubscriptionModal";this.controller=Clazz.com.wag.emailSubscriptionModal.js.EmailSubscriptionModalController;this.factory=Clazz.com.wag.emailSubscriptionModal.js.EmailSubscriptionModalFactory;this.service=Clazz.com.wag.emailSubscriptionModal.js.EmailSubscriptionModalService;},injectDependencies:function(){this.controller.emailSubscriptionModalController.$inject=["$scope","emailSubscriptionModalFactory","$wagUtil"];this.factory.emailSubscriptionModalFactory.$inject=["emailSubscriptionModalService"];this.service.emailSubscriptionModalService.$inject=["$wagAPI"];}});Clazz.com.wag.emailSubscriptionModal.js.EmailSubscriptionModalController={emailSubscriptionModalController:function($scope,emailSubscriptionModalFactory,$wagUtil){$scope.emailSubscriptionModel={};var svcUrl="/svc/preferences/(EmailSubscriptionPreferences)";var breakpoints={};breakpoints.mobile=true;breakpoints.app=false;breakpoints.tablet=true;breakpoints.desktop=true;$scope.emailSubscriptionModel.error=false;$scope.recentlyOptList=[];$scope.alreadyOptList=[];$scope.recentlyOpt=false;$scope.alreadyOpt=false;$scope.indIdx={newsLetterInd:"3",storeSpecialInd:"2",weeklyAdInd:"1",photoInd:"4",diabetesInd:"5",healthCareInd:"6",balanceRewardsInd:"0"};$scope.emailSubscriptionModel.subscribeEmail=function(email){if(!email||!(/^[^@]+@[^@]+\.[^@]+$/).test(email)){$scope.emailSubscriptionModel.error=true;return false;}else{$scope.emailSubscriptionModel.error=false;}$wagUtil.showLoading(breakpoints,$("#emailsubscribeoverlay .wag-modal-content"));var data={emailId:email,defaultOptIn:true,refURL:"/",type:"optIn",vendorSource:34};emailSubscriptionModalFactory.getEmailSubscriptionModalObj(data,svcUrl,function(data){$scope.emailSubscriptionModel.data=data;$scope.displyData($scope.emailSubscriptionModel.data.preferences);if($scope.emailSubscriptionModel.data.messages[0].code==="WAG_I_SIGNUP_EMAIL_1003"||$scope.emailSubscriptionModel.data.messages[0].code==="WAG_W_SIGNUP_EMAIL_1008"){dtmTrigger("Email subscription overlay|Opt in|homepage");var d=new Date();d.setFullYear(d.getFullYear()+1);document.cookie="EmlSubSt=Done; path=/; expires="+d.toUTCString();}$wagUtil.hideLoading($("#emailsubscribeoverlay .wag-modal-content"));});};$scope.displyData=function(dataArr){var dispCount=0;angular.forEach(dataArr,function(val,idx){if(val.recentlyOpted){if(val.desc==="Weekly Ad"){val.order=1;}else{if(val.desc==="Online Deals and Exclusives"){val.order=2;}else{val.order=3;}}val.desc=$("<div/>").html(val.desc).text();$scope.recentlyOptList.push(val);}else{angular.forEach(val,function(keyVal,key){if(key.search("Ind")>0){val.index=$scope.indIdx[key];if(keyVal){val.display=true;dispCount++;}}});val.desc=$("<div/>").html(val.desc).text();$scope.alreadyOptList.push(val);}});if($scope.recentlyOptList.length>0){$scope.recentlyOpt=true;}if(dispCount>0){$scope.alreadyOpt=true;}};var dtmTrigger=function(rule){if(window.dtmObject===undefined){window.dtmObject={};}if(window.dtmObject.BAS===undefined){window.dtmObject.BAS={};}window.dtmObject.BAS.Prop30=rule;$(document).trigger("triggerDTM","BAS_Home_Email_Subscription_Modal");};$("#emailsubscribeoverlay").on("hidden.bs.modal",function(e){if(!$scope.emailSubscriptionModel.emailInput){dtmTrigger("Email subscription overlay|Close overlay|homepage");}});}};Clazz.com.wag.emailSubscriptionModal.js.EmailSubscriptionModalFactory={emailSubscriptionModalFactory:function(emailSubscriptionModalService){var factory={};factory.getEmailSubscriptionModalObj=function(data,serviceurl,callback){emailSubscriptionModalService(data,serviceurl,callback);};return factory;}};Clazz.com.wag.emailSubscriptionModal.js.EmailSubscriptionModalService={emailSubscriptionModalService:function($wagAPI){return function(postData,path,callback){$wagAPI.config({method:"PUT",url:path,data:postData}).success(function(value){if(callback){callback(value);}});};}};Clazz.createPackage("com.wag.emailSubscriptionModalLazy.js");Clazz.com.wag.emailSubscriptionModalLazy.js.EmailSubscriptionModalLazy=Clazz.extend(Clazz.Widget,{initialize:function(){this.myContainer="wagEmailSubscriptionModalLazy";this.controller=Clazz.com.wag.emailSubscriptionModalLazy.js.EmailSubscriptionModalLazyController;this.factory=Clazz.com.wag.emailSubscriptionModalLazy.js.EmailSubscriptionModalLazyFactory;this.service=Clazz.com.wag.emailSubscriptionModalLazy.js.EmailSubscriptionModalLazyService;},injectDependencies:function(){this.controller.emailSubscriptionModalLazyController.$inject=["$scope","$compile","$wagUtil","emailSubscriptionModalLazyFactory"];this.factory.emailSubscriptionModalLazyFactory.$inject=["emailSubscriptionModalLazyService"];this.service.emailSubscriptionModalLazyService.$inject=["$wagAPI"];}});Clazz.com.wag.emailSubscriptionModalLazy.js.EmailSubscriptionModalLazyController={emailSubscriptionModalLazyController:function($scope,$compile,$wagUtil,emailSubscriptionModalLazyFactory){$scope.userInfo=false;$wagUtil.getUserInfo(function(response){$scope.userInfo=response;});$scope.lazyLoadEmailSubscription=function(){if((sessionStorage.getItem("EmailSubscriptionInSession")==null)&&(document.cookie.search("EmlSubSt=")===-1||document.cookie.match(/EmlSubSt=([^;]*)/)[1]!=="Done")){var EmailSubscriptionModalTemplateUrl=Clazz.App.getTemplateURL("assets.email-subscription-modal.template.EmailSubscriptionModal.tmpl");$.ajax({url:EmailSubscriptionModalTemplateUrl,success:function(EmailSubscriptionModal){angular.element("#EmailSubscriptionModal").html(EmailSubscriptionModal);$compile(angular.element("#EmailSubscriptionModal").contents())($scope);$("#emailsubscribeoverlay").modal();}});if(document.cookie.search("EmlSubSt=")===-1){var d=new Date();d.setTime(d.getTime()+(30*24*60*60*1000));var EmlSubSt="initiatedFor::"+d.toUTCString();document.cookie="EmlSubSt="+EmlSubSt+"; path=/; expires="+d.toUTCString();}else{if((document.cookie.search("EmlSubSt=initiatedFor")>-1)){var expiryStr=document.cookie.match(/EmlSubSt=initiatedFor::([^;]*)/)[1];var EmlSubSt="continuesUntil::"+expiryStr;document.cookie="EmlSubSt="+EmlSubSt+"; path=/; expires="+expiryStr;}else{if(document.cookie.match(/EmlSubSt=([^;]*)/)[1]!=="Done"){var d=new Date();d.setFullYear(d.getFullYear()+1);document.cookie="EmlSubSt=Done; path=/; expires="+d.toUTCString();}}}sessionStorage.setItem("EmailSubscriptionInSession","Done");}};$scope.showEmailSubscription=function(){if(document.readyState!=="complete"){if(window.attachEvent){window.attachEvent("onload",$scope.lazyLoadEmailSubscription);}else{window.addEventListener("load",$scope.lazyLoadEmailSubscription,false);}}else{$scope.lazyLoadEmailSubscription();}};$(document).on("emailSubscription",function(){if((sessionStorage.getItem("EmailSubscriptionInSession")==null)&&(document.cookie.search("EmlSubSt=")===-1||document.cookie.match(/EmlSubSt=([^;]*)/)[1]!=="Done")){if($scope.userInfo&&$scope.userInfo.profileInfo&&$scope.userInfo.profileInfo.loggedIn==="false"&&$scope.userInfo.profileInfo.recognizedState===false){$scope.showEmailSubscription();}else{if($scope.userInfo&&$scope.userInfo.profileInfo&&$scope.userInfo.profileInfo.recognizedState){var svcUrl=" /svc/profiles/0/email/(CheckSubscription)";emailSubscriptionModalLazyFactory.getEmailSubscriptionStateObj(svcUrl,function(data){if(data&&!data.subscribed){$scope.showEmailSubscription();}else{var d=new Date();d.setFullYear(d.getFullYear()+1);document.cookie="EmlSubSt=Done; path=/; expires="+d.toUTCString();}});}else{var d=new Date();d.setFullYear(d.getFullYear()+1);document.cookie="EmlSubSt=Done; path=/; expires="+d.toUTCString();}}}});}};Clazz.com.wag.emailSubscriptionModalLazy.js.EmailSubscriptionModalLazyFactory={emailSubscriptionModalLazyFactory:function(emailSubscriptionModalLazyService){var factory={};factory.getEmailSubscriptionStateObj=function(serviceurl,callback){emailSubscriptionModalLazyService(serviceurl,callback);};return factory;}};Clazz.com.wag.emailSubscriptionModalLazy.js.EmailSubscriptionModalLazyService={emailSubscriptionModalLazyService:function($wagAPI){return function(path,callback){$wagAPI.config({method:"GET",url:path}).success(function(value){if(callback){callback(value);}});};}};